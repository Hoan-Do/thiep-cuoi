<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoàn&Huyền</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Cấu hình log để dễ debug
        setLogLevel('debug');

        let db, auth, userId;
        
        // BƯỚC 1: DÁN "appId" của bạn vào đây
        // Sử dụng projectId của bạn
        const appId = 'thiep-cuoi-c3d08';

        // BƯỚC 2: DÁN "firebaseConfig" của bạn vào đây
        // Sao chép và dán toàn bộ đối tượng từ Firebase Console > Project settings > Your apps
        const firebaseConfig = {
            apiKey: "AIzaSyBA68TNBDx4T23PfkZTcU1RwWmDeQUgY",
            authDomain: "thiep-cuoi-c3d08.firebaseapp.com",
            projectId: "thiep-cuoi-c3d08",
            storageBucket: "thiep-cuoi-c3d08.appspot.com",
            messagingSenderId: "221614290",
            appId: "1:221614290:web:a3db7a9973261b9b3a0d8b"
        };
        
        // LƯU Ý QUAN TRỌNG: CẬP NHẬT FIREBASE SECURITY RULES
        // Lỗi "đang đăng nhập" có thể là do thiếu quyền truy cập.
        // Vui lòng vào Firebase Console > Firestore Database > Rules
        // và thay thế toàn bộ nội dung bằng đoạn code dưới đây.
        // Điều này sẽ cho phép người dùng đã xác thực (bao gồm cả ẩn danh)
        // đọc và viết dữ liệu vào bộ sưu tập 'guestbook'.
        //
        // rules_version = '2';
        // service cloud.firestore {
        //   match /databases/{database}/documents {
        //     match /artifacts/{appId}/public/data/guestbook/{messageId} {
        //       allow read, write: if request.auth != null;
        //     }
        //   }
        // }
        
        // Kiểm tra nếu là chế độ admin
        const urlParams = new URLSearchParams(window.location.search);
        const isAdminMode = urlParams.get('admin') === 'true';
        const guestName = urlParams.get('to');

        // Hiển thị tên khách mời nếu có
        if (guestName) {
            document.addEventListener('DOMContentLoaded', () => {
                const guestNameElement = document.getElementById('guest-name-display');
                if (guestNameElement) {
                    guestNameElement.textContent = decodeURIComponent(guestName);
                }
            });
        }

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("User signed in:", userId);
                    if (document.getElementById('user-id')) {
                        document.getElementById('user-id').textContent = userId;
                    }
                    if (isAdminMode && !user.isAnonymous) {
                        loadAdminPanel();
                    } else if (!isAdminMode) {
                        loadGuestbook();
                    }
                } else {
                    console.log("No user signed in yet, signing in anonymously...");
                    if (document.getElementById('user-id')) {
                        document.getElementById('user-id').textContent = 'Đang đăng nhập...';
                    }
                }
            });

            if (typeof __initial_auth_token !== 'undefined') {
                // Tùy chọn này chỉ dùng trong môi trường dev, không cần cho GitHub Pages
            } else {
                signInAnonymously(auth);
            }

        } catch (e) {
            console.error("Firebase initialization error:", e);
        }

        // Functions for guestbook
        window.submitGuestbook = async () => {
            const name = document.getElementById('guest-name').value;
            const message = document.getElementById('guest-message').value;
            const formStatus = document.getElementById('form-status');

            if (!name || !message) {
                formStatus.textContent = 'Vui lòng điền tên và lời chúc.';
                formStatus.className = 'text-red-500 mt-2';
                return;
            }

            try {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const date = `${year}-${month}-${day}`;

                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/guestbook`), {
                    name,
                    message,
                    timestamp: date,
                    approved: true // Lời chúc mới sẽ được duyệt ngay lập tức
                });
                console.log("Document written with ID: ", docRef.id);
                document.getElementById('guest-name').value = '';
                document.getElementById('guest-message').value = '';
                formStatus.textContent = 'Lời chúc của bạn đã được gửi thành công!';
                formStatus.className = 'text-green-500 mt-2';
            } catch (e) {
                console.error("Error adding document: ", e);
                formStatus.textContent = 'Có lỗi xảy ra, vui lòng thử lại.';
                formStatus.className = 'text-red-500 mt-2';
            }
        };

        // Hàm để tải và hiển thị các lời chúc đã được duyệt
        function loadGuestbook() {
            if (!db) return;
            const q = query(collection(db, `artifacts/${appId}/public/data/guestbook`), where("approved", "==", true));
            onSnapshot(q, (querySnapshot) => {
                const messages = [];
                querySnapshot.forEach((doc) => {
                    messages.push(doc.data());
                });

                // Sắp xếp tin nhắn theo timestamp (mới nhất lên đầu)
                messages.sort((a, b) => b.timestamp.localeCompare(a.timestamp));
                
                const guestbookList = document.getElementById('guestbook-list');
                guestbookList.innerHTML = '';
                messages.forEach(msg => {
                    const li = document.createElement('li');
                    li.className = 'bg-stone-50 p-4 rounded-xl shadow-sm mb-4 border border-stone-200';
                    li.innerHTML = `
                        <p class="font-bold text-lg text-rose-500">${msg.name}</p>
                        <p class="text-stone-700 mt-2 italic">${msg.message}</p>
                        <p class="text-xs text-stone-500 mt-2 text-right">Ngày gửi: ${msg.timestamp}</p>
                    `;
                    guestbookList.appendChild(li);
                });
            });
        }
        
        // Hàm để duyệt lại một lời chúc
        window.approveMessage = async (docId) => {
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/guestbook`, docId);
                await updateDoc(docRef, {
                    approved: true
                });
                console.log("Document successfully approved!");
            } catch (e) {
                console.error("Error approving document:", e);
            }
        };

        // Hàm để ẩn một lời chúc
        window.hideMessage = async (docId) => {
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/guestbook`, docId);
                await updateDoc(docRef, {
                    approved: false
                });
                console.log("Document successfully hidden!");
            } catch (e) {
                console.error("Error hiding document:", e);
            }
        };

        function loadAdminPanel() {
            if (!db) return;
            const adminPanel = document.getElementById('admin-panel');
            adminPanel.style.display = 'block';

            // Load tất cả các lời chúc, không giới hạn
            const q = query(collection(db, `artifacts/${appId}/public/data/guestbook`));
            
            onSnapshot(q, (querySnapshot) => {
                const messages = [];
                querySnapshot.forEach((doc) => {
                    messages.push({ id: doc.id, ...doc.data() });
                });

                // Sắp xếp tin nhắn theo timestamp (mới nhất lên đầu)
                messages.sort((a, b) => b.timestamp.localeCompare(a.timestamp));
                
                const pendingList = document.getElementById('pending-list');
                pendingList.innerHTML = '';
                messages.forEach(msg => {
                    const li = document.createElement('li');
                    li.className = `p-4 rounded-xl shadow-sm mb-4 border border-stone-200 ${msg.approved ? 'bg-green-100' : 'bg-red-100'}`;
                    li.innerHTML = `
                        <p class="font-bold text-lg text-stone-700">${msg.name}</p>
                        <p class="text-stone-600 mt-2 italic">${msg.message}</p>
                        <p class="text-xs text-stone-500 mt-2 text-right">Ngày gửi: ${msg.timestamp}</p>
                        <p class="text-xs font-bold mt-1 text-right">${msg.approved ? 'Đã duyệt' : 'Đã ẩn'}</p>
                        ${msg.approved ? `<button onclick="hideMessage('${msg.id}')" class="mt-2 w-full bg-red-500 text-white rounded-md py-1 font-semibold hover:bg-red-600">Ẩn</button>` : `<button onclick="approveMessage('${msg.id}')" class="mt-2 w-full bg-blue-500 text-white rounded-md py-1 font-semibold hover:bg-blue-600">Duyệt</button>`}
                    `;
                    pendingList.appendChild(li);
                });
            });
        }
    </script>
    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #f8f0e5;
            color: #4b5563; /* text-gray-600 */
            scroll-behavior: smooth;
        }
        .playfair-font {
            font-family: 'Playfair Display', serif;
        }
        .bg-cover-image {
            background-image: url('https://placehold.co/1200x800/e0c2a5/fff?text=Ảnh+cưới+đẹp');
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Trang bìa -->
    <header id="home" class="h-screen bg-cover-image flex flex-col justify-center items-center text-center text-white p-4 relative">
        <div class="absolute inset-0 bg-black opacity-40"></div>
        <div class="relative z-10">
            <h1 class="playfair-font text-4xl sm:text-6xl md:text-8xl font-bold mb-4 animate-fadeIn">Văn Hoàn & Ngọc Huyền</h1>
            <p class="quicksand-font text-lg sm:text-xl md:text-2xl font-semibold mb-6 animate-fadeInDelay">Trân trọng kính mời <span id="guest-name-display" class="font-bold"></span></p>
            <p class="quicksand-font text-lg sm:text-xl md:text-2xl animate-fadeInDelay">Thứ Bảy, ngày 10 tháng 10 năm 2025</p>
        </div>
        <a href="#details" class="absolute bottom-10 animate-bounce cursor-pointer">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
        </a>
    </header>

    <!-- Chi tiết sự kiện -->
    <section id="details" class="py-16 px-4 bg-white text-center">
        <h2 class="playfair-font text-3xl font-bold text-rose-500 mb-8">Chi Tiết Sự Kiện</h2>
        <div class="max-w-3xl mx-auto space-y-8 md:space-y-0 md:flex md:gap-8">
            <div class="flex-1 bg-stone-50 p-6 rounded-3xl shadow-lg border border-stone-200">
                <h3 class="playfair-font text-2xl font-semibold text-stone-700 mb-4">Lễ Thành Hôn</h3>
                <p class="quicksand-font text-lg font-semibold mb-2 text-rose-500">Tại nhà trai</p>
                <p class="mb-1">⏰ Thời gian: <span class="font-semibold">09:00</span></p>
                <p class="mb-1">📅 Ngày: <span class="font-semibold">Thứ Bảy, ngày 10/10/2025</span></p>
                <p>📍 Địa điểm: <a href="https://maps.app.goo.gl/placeholder1" target="_blank" class="font-semibold text-blue-600 hover:underline">Nhà riêng chú rể</a></p>
            </div>
            <div class="flex-1 bg-stone-50 p-6 rounded-3xl shadow-lg border border-stone-200">
                <h3 class="playfair-font text-2xl font-semibold text-stone-700 mb-4">Tiệc Cưới</h3>
                <p class="quicksand-font text-lg font-semibold mb-2 text-rose-500">Tại nhà hàng</p>
                <p class="mb-1">⏰ Thời gian: <span class="font-semibold">18:00</span></p>
                <p class="mb-1">📅 Ngày: <span class="font-semibold">Thứ Bảy, ngày 10/10/2025</span></p>
                <p>📍 Địa điểm: <a href="https://maps.app.goo.gl/placeholder2" target="_blank" class="font-semibold text-blue-600 hover:underline">Nhà Hàng ABC, 123 Đường XYZ, TP. HCM</a></p>
            </div>
        </div>
    </section>

    <!-- Câu chuyện tình yêu -->
    <section id="story" class="py-16 px-4 bg-rose-50 text-center">
        <h2 class="playfair-font text-3xl font-bold text-rose-500 mb-8">Câu Chuyện Của Chúng Tôi</h2>
        <div class="max-w-4xl mx-auto">
            <div class="md:flex md:items-center md:gap-8 mb-8">
                <div class="md:w-1/2 mb-4 md:mb-0">
                    <img src="https://placehold.co/600x400/fff3d6/e0c2a5?text=Ảnh+kỷ+niệm+1" alt="Our story photo 1" class="rounded-3xl shadow-lg w-full">
                </div>
                <div class="md:w-1/2 text-left">
                    <h3 class="playfair-font text-xl font-semibold text-stone-700 mb-2">Lần đầu gặp gỡ...</h3>
                    <p class="text-sm text-stone-600 leading-relaxed">Câu chuyện tình yêu của chúng tôi bắt đầu từ một buổi gặp gỡ tình cờ. Ánh mắt đầu tiên, nụ cười đầu tiên... đều là những khoảnh khắc đáng nhớ, là điểm khởi đầu cho một hành trình dài đầy ắp kỷ niệm.</p>
                </div>
            </div>
            <div class="md:flex md:flex-row-reverse md:items-center md:gap-8">
                <div class="md:w-1/2 mb-4 md:mb-0">
                    <img src="https://placehold.co/600x400/fff3d6/e0c2a5?text=Ảnh+kỷ+niệm+2" alt="Our story photo 2" class="rounded-3xl shadow-lg w-full">
                </div>
                <div class="md:w-1/2 text-left">
                    <h3 class="playfair-font text-xl font-semibold text-stone-700 mb-2">Hành trình yêu thương...</h3>
                    <p class="text-sm text-stone-600 leading-relaxed">Chúng tôi đã cùng nhau vượt qua bao thử thách, chia sẻ niềm vui và cả những nỗi buồn. Mỗi khoảnh khắc đều trở thành một phần của câu chuyện, một viên gạch xây nên ngôi nhà hạnh phúc của chúng tôi.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Bộ sưu tập ảnh -->
    <section id="gallery" class="py-16 px-4 bg-white text-center">
        <h2 class="playfair-font text-3xl font-bold text-rose-500 mb-8">Album Ảnh Cưới</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-w-6xl mx-auto">
            <img src="https://placehold.co/400x400/e0c2a5/fff?text=Ảnh+1" alt="Gallery photo 1" class="w-full h-auto rounded-xl shadow-md">
            <img src="https://placehold.co/400x400/e0c2a5/fff?text=Ảnh+2" alt="Gallery photo 2" class="w-full h-auto rounded-xl shadow-md">
            <img src="https://placehold.co/400x400/e0c2a5/fff?text=Ảnh+3" alt="Gallery photo 3" class="w-full h-auto rounded-xl shadow-md">
            <img src="https://placehold.co/400x400/e0c2a5/fff?text=Ảnh+4" alt="Gallery photo 4" class="w-full h-auto rounded-xl shadow-md">
            <img src="https://placehold.co/400x400/e0c2a5/fff?text=Ảnh+5" alt="Gallery photo 5" class="w-full h-auto rounded-xl shadow-md">
            <img src="https://placehold.co/400x400/e0c2a5/fff?text=Ảnh+6" alt="Gallery photo 6" class="w-full h-auto rounded-xl shadow-md">
            <img src="https://placehold.co/400x400/e0c2a5/fff?text=Ảnh+7" alt="Gallery photo 7" class="w-full h-auto rounded-xl shadow-md">
            <img src="https://placehold.co/400x400/e0c2a5/fff?text=Ảnh+8" alt="Gallery photo 8" class="w-full h-auto rounded-xl shadow-md">
        </div>
    </section>

    <!-- Sổ lưu bút -->
    <section id="guestbook" class="py-16 px-4 bg-rose-50 text-center">
        <h2 class="playfair-font text-3xl font-bold text-rose-500 mb-8">Sổ Lưu Bút & Lời Chúc</h2>
        <div class="max-w-2xl mx-auto">
            <!-- Form gửi lời chúc -->
            <div class="bg-white p-6 rounded-3xl shadow-lg border border-stone-200 mb-8">
                <form onsubmit="event.preventDefault(); submitGuestbook();">
                    <div class="mb-4">
                        <label for="guest-name" class="block text-sm font-medium text-gray-700 text-left mb-1">Tên của bạn:</label>
                        <input type="text" id="guest-name" class="block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                    </div>
                    <div class="mb-4">
                        <label for="guest-message" class="block text-sm font-medium text-gray-700 text-left mb-1">Lời chúc:</label>
                        <textarea id="guest-message" rows="4" class="block w-full rounded-md border-gray-300 shadow-sm p-2 border" required></textarea>
                    </div>
                    <button type="submit" class="w-full bg-rose-500 text-white rounded-md py-2 font-semibold hover:bg-rose-600 transition-colors">Gửi Lời Chúc</button>
                    <p id="form-status" class="text-sm mt-2"></p>
                </form>
            </div>
            
            <!-- Danh sách lời chúc -->
            <ul id="guestbook-list" class="text-left mt-8">
                <!-- Lời chúc sẽ được load tại đây -->
            </ul>
        </div>
        <p class="text-sm text-stone-400 mt-8">User ID của bạn: <span id="user-id">Đang tải...</span></p>
    </section>

    <!-- Admin Panel (mặc định ẩn) -->
    <section id="admin-panel" class="py-16 px-4 bg-white text-center hidden">
        <hr class="mb-8 border-t-2 border-stone-300"/>
        <h2 class="playfair-font text-3xl font-bold text-stone-700 mb-8">Trang Quản Lý Lời Chúc</h2>
        <p class="text-stone-600 mb-4">Các lời chúc đã duyệt và bị ẩn:</p>
        <div class="max-w-2xl mx-auto">
            <ul id="pending-list" class="text-left">
                <!-- Danh sách lời chúc chờ duyệt sẽ được load tại đây -->
            </ul>
        </div>
    </section>


    <!-- Chân trang -->
    <footer class="bg-stone-900 text-white py-8 text-center">
        <p class="text-sm">Copyright © <span id="current-year"></span> Văn Hoàn & Ngọc Huyền. All Rights Reserved.</p>
        <p class="text-xs text-stone-400 mt-2">Được tạo bởi Gemini.</p>
    </footer>

    <script>
        document.getElementById('current-year').textContent = new Date().getFullYear();
    </script>
</body>
</html>
